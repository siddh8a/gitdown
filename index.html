<!DOCTYPE html>
<html lang="en" class="transition-colors duration-300">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GitCloud Pro - Copy Feature</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&family=Fira+Code:wght@400&display=swap"
        rel="stylesheet">

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Plus Jakarta Sans', 'sans-serif'],
                        mono: ['Fira Code', 'monospace'],
                    },
                    animation: {
                        'blob': 'blob 7s infinite',
                        'fade-in-up': 'fadeInUp 0.5s ease-out forwards',
                    },
                    keyframes: {
                        blob: {
                            '0%': { transform: 'translate(0px, 0px) scale(1)' },
                            '33%': { transform: 'translate(30px, -50px) scale(1.1)' },
                            '66%': { transform: 'translate(-20px, 20px) scale(0.9)' },
                            '100%': { transform: 'translate(0px, 0px) scale(1)' },
                        },
                        fadeInUp: {
                            '0%': { opacity: '0', transform: 'translateY(20px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 5px;
        }

        .dark ::-webkit-scrollbar-thumb {
            background: #475569;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        .glass {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
        }

        .dark .glass {
            background: rgba(30, 41, 59, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
    </style>
</head>

<body
    class="bg-gray-50 text-slate-800 dark:bg-slate-950 dark:text-slate-100 transition-colors duration-300 overflow-x-hidden font-sans">

    <nav class="fixed w-full z-50 glass border-b border-gray-200 dark:border-slate-800 transition-colors duration-300">
        <div class="max-w-7xl mx-auto px-4 h-16 flex items-center justify-between">
            <div class="flex items-center gap-3 cursor-pointer group" onclick="goHome()">
                <div
                    class="bg-indigo-600 text-white p-1.5 rounded-lg group-hover:rotate-12 transition-transform shadow-lg shadow-indigo-500/30">
                    <i data-lucide="cloud-lightning" class="w-5 h-5"></i>
                </div>
                <span class="font-bold text-xl tracking-tight">GitCloud</span>
            </div>

            <div class="flex items-center gap-2">
                <a href="https://linkedin.com/in/siddharthachaurasia" target="_blank" class="p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-slate-800 text-slate-500 dark:text-slate-400 transition-colors" title="Visit LinkedIn">
                    <i data-lucide="linkedin" class="w-5 h-5"></i>
                </a>
                <button onclick="toggleTheme()"
                    class="p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-slate-800 text-slate-500 dark:text-slate-400 transition-colors">
                    <i data-lucide="moon" class="w-5 h-5 hidden dark:block"></i>
                    <i data-lucide="sun" class="w-5 h-5 dark:hidden"></i>
                </button>
                <button onclick="goHome()"
                    class="p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-slate-800 text-slate-500 dark:text-slate-400 transition-colors"
                    title="Logout">
                    <i data-lucide="log-out" class="w-5 h-5"></i>
                </button>
            </div>
        </div>
    </nav>

    <div class="fixed inset-0 overflow-hidden pointer-events-none -z-10">
        <div
            class="absolute top-0 left-1/4 w-96 h-96 bg-indigo-200 dark:bg-indigo-900/30 rounded-full mix-blend-multiply dark:mix-blend-screen filter blur-3xl opacity-70 animate-blob">
        </div>
        <div
            class="absolute top-0 right-1/4 w-96 h-96 bg-purple-200 dark:bg-purple-900/30 rounded-full mix-blend-multiply dark:mix-blend-screen filter blur-3xl opacity-70 animate-blob animation-delay-2000">
        </div>
    </div>

    <div id="landingView" class="min-h-screen flex flex-col justify-center items-center relative p-6 pt-20">
        <div class="relative z-10 text-center max-w-3xl w-full animate-fade-in-up">
            <div
                class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-indigo-50 dark:bg-indigo-900/30 border border-indigo-100 dark:border-indigo-800 text-indigo-600 dark:text-indigo-400 text-sm font-semibold mb-6">
                <i data-lucide="link" class="w-4 h-4"></i>
                <span>Direct Links Supported</span>
            </div>

            <h1 class="text-5xl md:text-7xl font-bold tracking-tight mb-6 text-slate-900 dark:text-white">
                GitHub Repos <br>
                <span
                    class="text-transparent bg-clip-text bg-gradient-to-r from-indigo-600 to-purple-600 dark:from-indigo-400 dark:to-purple-400">Downloader</span>
            </h1>

            <p class="text-lg text-slate-500 dark:text-slate-400 mb-10 max-w-xl mx-auto">
                Paste a username or a direct GitHub link (file or folder) to access it instantly.
            </p>

            <div
                class="glass p-2 rounded-2xl shadow-xl shadow-indigo-500/10 border border-white/20 flex flex-col sm:flex-row items-center gap-2 max-w-xl mx-auto transform transition-all hover:scale-[1.01]">
                <div class="pl-4 text-slate-400">
                    <i data-lucide="search" class="w-6 h-6"></i>
                </div>
                <input type="text" id="landingInput"
                    class="w-full bg-transparent border-none text-lg text-slate-800 dark:text-white placeholder:text-slate-400 focus:outline-none"
                    placeholder="Enter a username or paste a link to begin."
                    onkeydown="if(event.key === 'Enter') handleSearch('landing')">

                <button onclick="handleSearch('landing')"
                    class="w-full sm:w-auto px-8 h-12 bg-slate-900 dark:bg-indigo-600 hover:bg-slate-800 dark:hover:bg-indigo-500 text-white font-semibold rounded-xl transition-colors flex items-center justify-center gap-2 shadow-lg">
                    <span>Go</span>
                </button>
            </div>

            <div class="mt-4">
                <input type="password" id="landingToken" placeholder="GitHub Token (Optional)"
                    class="text-xs text-center bg-transparent border-b border-slate-300 dark:border-slate-700 focus:border-indigo-500 outline-none w-48 py-1 text-slate-600 dark:text-slate-400 transition-colors">
            </div>
        </div>
    </div>


    <div id="dashboardView"
        class="hidden min-h-screen pt-24 pb-12 px-4 md:px-8 max-w-7xl mx-auto w-full flex flex-col md:flex-row gap-8">

        <aside class="w-full md:w-72 flex-shrink-0 animate-fade-in-up">
            <div class="glass rounded-2xl p-6 shadow-sm sticky top-24 text-center">
                <div class="relative inline-block">
                    <img id="avatar" src=""
                        class="w-24 h-24 rounded-full border-4 border-white dark:border-slate-700 shadow-xl mx-auto mb-4">
                </div>
                <h2 id="displayName" class="text-xl font-bold"></h2>
                <p id="loginName" class="text-indigo-500 dark:text-indigo-400 font-medium text-sm mb-6"></p>

                <div
                    class="grid grid-cols-2 gap-2 text-center bg-slate-50 dark:bg-slate-800/50 rounded-xl p-3 border border-slate-100 dark:border-slate-700">
                    <div>
                        <span class="block text-xl font-bold" id="repoCount">0</span>
                        <span class="text-xs text-slate-500 uppercase tracking-wider font-semibold">Repos</span>
                    </div>
                    <div>
                        <span class="block text-xl font-bold" id="followers">0</span>
                        <span class="text-xs text-slate-500 uppercase tracking-wider font-semibold">Followers</span>
                    </div>
                </div>

                <div class="mt-4 relative">
                    <input type="text" id="navInput"
                        class="w-full bg-slate-100 dark:bg-slate-800/50 border-none rounded-lg py-2 px-4 text-sm focus:ring-2 focus:ring-indigo-500 dark:text-white"
                        placeholder="Search..." onkeydown="if(event.key === 'Enter') handleSearch('nav')">
                </div>
            </div>
        </aside>

        <main class="flex-1 flex flex-col min-h-[600px] animate-fade-in-up" style="animation-delay: 0.1s">

            <div id="toolbar"
                class="hidden flex flex-wrap items-center justify-between gap-4 mb-6 glass p-4 rounded-xl shadow-sm">
                <div id="breadcrumbs"
                    class="flex items-center gap-2 text-sm font-medium text-slate-500 dark:text-slate-400"></div>

                <button id="downloadBtn" onclick="downloadCurrentView()" disabled
                    class="bg-slate-900 dark:bg-indigo-600 hover:bg-slate-800 dark:hover:bg-indigo-500 disabled:opacity-50 disabled:cursor-not-allowed text-white px-5 py-2.5 rounded-lg text-sm font-semibold transition-all flex items-center gap-2 shadow-lg">
                    <i data-lucide="download" class="w-4 h-4"></i>
                    <span>Download Folder</span>
                </button>
            </div>

            <div id="contentGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                <div class="col-span-full flex flex-col items-center justify-center text-center py-20 text-slate-400">
                    <div class="bg-slate-100 dark:bg-slate-800 p-4 rounded-full mb-4">
                        <i data-lucide="search" class="w-8 h-8"></i>
                    </div>
                    <p>Enter a username or paste a link to begin.</p>
                </div>
            </div>

            <div id="loader" class="hidden col-span-full flex justify-center py-20">
                <div class="animate-spin rounded-full h-10 w-10 border-2 border-indigo-600 border-t-transparent"></div>
            </div>
        </main>
    </div>

    <div id="previewModal" class="fixed inset-0 z-[100] hidden">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" onclick="closePreview()"></div>
        <div
            class="absolute inset-4 md:inset-10 bg-white dark:bg-slate-900 rounded-2xl shadow-2xl flex flex-col border border-slate-200 dark:border-slate-700 overflow-hidden animate-fade-in-up">
            <div
                class="flex items-center justify-between p-4 border-b border-slate-100 dark:border-slate-800 bg-slate-50 dark:bg-slate-800/50">
                <div class="flex items-center gap-3">
                    <i data-lucide="file-code" class="w-5 h-5 text-indigo-500"></i>
                    <h3 id="previewTitle"
                        class="font-mono font-semibold text-slate-700 dark:text-slate-200 truncate max-w-md">Filename.js
                    </h3>
                </div>
                <div class="flex items-center gap-2">
                    <button id="previewCopyBtn"
                        class="bg-white dark:bg-slate-800 hover:bg-slate-100 dark:hover:bg-slate-700 border border-slate-200 dark:border-slate-700 text-slate-700 dark:text-slate-200 px-3 py-1.5 rounded-lg text-sm font-medium flex items-center gap-2 transition-colors">
                        <i data-lucide="copy" class="w-4 h-4"></i> Copy
                    </button>
                    <button id="previewDownloadBtn"
                        class="bg-indigo-600 hover:bg-indigo-700 text-white px-3 py-1.5 rounded-lg text-sm font-medium flex items-center gap-2 transition-colors">
                        <i data-lucide="download" class="w-4 h-4"></i> Download
                    </button>
                    <button onclick="closePreview()"
                        class="p-2 hover:bg-slate-200 dark:hover:bg-slate-700 rounded-lg transition-colors">
                        <i data-lucide="x" class="w-5 h-5 text-slate-500"></i>
                    </button>
                </div>
            </div>
            <div class="flex-1 overflow-auto p-4 bg-slate-50 dark:bg-[#0d1117]">
                <pre id="previewContent"
                    class="font-mono text-sm text-slate-800 dark:text-slate-300 whitespace-pre-wrap hidden"></pre>
                <div id="previewImageContainer" class="hidden flex items-center justify-center h-full">
                    <img id="previewImage" src="" class="max-w-full max-h-full rounded-lg shadow-lg">
                </div>
                <div id="previewLoader" class="flex items-center justify-center h-full text-slate-400 gap-2">
                    <div class="animate-spin w-5 h-5 border-2 border-indigo-500 border-t-transparent rounded-full">
                    </div> Loading...
                </div>
            </div>
        </div>
    </div>

    <div id="toastContainer" class="fixed bottom-6 right-6 z-[60] flex flex-col gap-2"></div>

    <script>
        lucide.createIcons();

        // --- STATE ---
        let state = { username: '', currentRepo: null, currentPath: '', branch: '', items: [], token: '' };

        // --- THEME ---
        function toggleTheme() {
            document.documentElement.classList.toggle('dark');
            localStorage.setItem('theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light');
        }
        if (localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
        }

        // --- UI & NAV ---
        const views = { landing: document.getElementById('landingView'), dashboard: document.getElementById('dashboardView') };
        const inputs = { landing: document.getElementById('landingInput'), nav: document.getElementById('navInput'), token: document.getElementById('landingToken') };
        const ui = {
            grid: document.getElementById('contentGrid'),
            toolbar: document.getElementById('toolbar'),
            breadcrumbs: document.getElementById('breadcrumbs'),
            loader: document.getElementById('loader'),
            dlBtn: document.getElementById('downloadBtn'),
            avatar: document.getElementById('avatar'),
            dName: document.getElementById('displayName'),
            lName: document.getElementById('loginName'),
            rCount: document.getElementById('repoCount'),
            followers: document.getElementById('followers')
        };

        function goHome() {
            views.dashboard.classList.add('hidden');
            views.landing.classList.remove('hidden');
            inputs.landing.value = '';
            inputs.landing.focus();
        }

        // --- URL PARSING LOGIC ---
        function parseGitHubUrl(input) {
            try {
                if (!input.startsWith('http')) {
                    const parts = input.split('/');
                    if (parts.length === 2) return { user: parts[0], repo: parts[1] };
                    return { user: input };
                }

                const url = new URL(input);
                if (url.hostname !== 'github.com') return null;

                const parts = url.pathname.split('/').filter(Boolean);
                if (parts.length < 1) return null;

                return {
                    user: parts[0],
                    repo: parts[1] || null,
                    type: parts[2] || null, // tree or blob
                    branch: parts[3] || null,
                    path: parts.slice(4).join('/') || ''
                };
            } catch { return null; }
        }

        async function handleSearch(source) {
            const inputVal = source === 'landing' ? inputs.landing.value.trim() : inputs.nav.value.trim();
            state.token = inputs.token.value.trim();

            if (!inputVal) return showToast("Please enter a value", "error");

            const parsed = parseGitHubUrl(inputVal);

            if (!parsed || !parsed.user) {
                return showToast("Invalid input", "error");
            }

            // Sync State
            state.username = parsed.user;
            state.currentRepo = parsed.repo;
            state.currentPath = parsed.path;
            state.branch = parsed.branch;

            // Sync Input UI
            inputs.nav.value = state.username;

            // Switch View
            views.landing.classList.add('hidden');
            views.dashboard.classList.remove('hidden');
            ui.grid.innerHTML = '';

            // Load Data
            await loadUserAndRepos();

            if (state.currentRepo) {
                ui.toolbar.classList.remove('hidden');
                if (parsed.type === 'blob') {
                    const pathParts = state.currentPath.split('/');
                    pathParts.pop();
                    state.currentPath = pathParts.join('/');
                    await loadPathContents();
                    showToast("Navigated to containing folder", "info");
                } else {
                    await loadPathContents();
                }
            } else {
                ui.toolbar.classList.add('hidden');
            }
        }

        // --- DATA FETCHING ---
        async function loadUserAndRepos() {
            try {
                // Profile
                const userRes = await githubFetch(`https://api.github.com/users/${state.username}`);
                if (!userRes.ok) throw new Error("User not found");
                const user = await userRes.json();

                ui.avatar.src = user.avatar_url;
                ui.dName.textContent = user.name || user.login;
                ui.lName.textContent = `@${user.login}`;
                ui.rCount.textContent = user.public_repos;
                ui.followers.textContent = user.followers;

                // Repos
                const reposRes = await githubFetch(`https://api.github.com/users/${state.username}/repos?sort=updated&per_page=100`);
                const repos = await reposRes.json();

                if (!state.currentRepo) {
                    renderRepos(repos);
                }

            } catch (err) {
                ui.grid.innerHTML = `<div class="col-span-full text-center text-red-500 font-medium py-10 glass rounded-xl">${err.message}</div>`;
                showToast(err.message, "error");
            }
        }

        async function openRepo(repoName) {
            state.currentRepo = repoName;
            state.currentPath = '';
            state.branch = '';
            ui.toolbar.classList.remove('hidden');
            await loadPathContents();
        }

        async function openFolder(path) {
            state.currentPath = path;
            await loadPathContents();
        }

        async function loadPathContents() {
            showLoader(true);
            updateBreadcrumbs();
            try {
                let url = `https://api.github.com/repos/${state.username}/${state.currentRepo}/contents/${state.currentPath}`;
                if (state.branch) url += `?ref=${state.branch}`;

                const res = await githubFetch(url);
                if (!res.ok) throw new Error("Failed to load content");

                const data = await res.json();
                state.items = Array.isArray(data) ? data : [data];
                renderFiles(state.items);
            } catch (err) {
                showToast("Failed to load contents", "error");
            } finally {
                showLoader(false);
            }
        }

        // --- RENDERING ---
        function renderRepos(repos) {
            ui.dlBtn.disabled = true;
            if (repos.length === 0) return ui.grid.innerHTML = `<div class="col-span-full text-center text-slate-500">No public repositories.</div>`;

            ui.grid.innerHTML = repos.map(repo => `
                <div onclick="openRepo('${repo.name}')" class="glass bg-white/50 dark:bg-slate-800/50 p-6 rounded-xl cursor-pointer shadow-sm relative group overflow-hidden hover:border-indigo-500 dark:hover:border-indigo-500 transition-all border border-transparent">
                    <div class="flex items-start justify-between mb-3">
                        <div class="p-2 bg-indigo-50 dark:bg-indigo-900/30 text-indigo-600 dark:text-indigo-400 rounded-lg">
                            <i data-lucide="book" class="w-5 h-5"></i>
                        </div>
                        <span class="text-xs font-semibold bg-slate-100 dark:bg-slate-700 text-slate-500 dark:text-slate-300 px-2 py-1 rounded-md border border-slate-200 dark:border-slate-600">${repo.language || 'N/A'}</span>
                    </div>
                    <h3 class="font-bold text-lg text-slate-800 dark:text-slate-100 mb-1 truncate">${repo.name}</h3>
                    <p class="text-sm text-slate-500 dark:text-slate-400 line-clamp-2 h-10 mb-4">${repo.description || 'No description available'}</p>
                    <div class="flex items-center gap-4 text-xs font-medium text-slate-400">
                        <span class="flex items-center gap-1"><i data-lucide="star" class="w-3 h-3"></i> ${repo.stargazers_count}</span>
                        <span class="flex items-center gap-1"><i data-lucide="git-branch" class="w-3 h-3"></i> ${repo.default_branch}</span>
                    </div>
                </div>
            `).join('');
            lucide.createIcons();
        }

        function renderFiles(items) {
            ui.dlBtn.disabled = false;
            items.sort((a, b) => (a.type === b.type ? 0 : a.type === 'dir' ? -1 : 1));

            if (items.length === 0) return ui.grid.innerHTML = `<div class="col-span-full text-center text-slate-400 italic">Empty folder</div>`;

            ui.grid.innerHTML = items.map(item => {
                const isDir = item.type === 'dir';
                const icon = isDir ? 'folder' : 'file';
                const iconClass = isDir ? 'text-indigo-500 fill-indigo-500/20' : 'text-slate-400';

                const mainAction = isDir ? `onclick="openFolder('${item.path}')"` : ``;
                const previewAction = !isDir ? `onclick="openPreview('${item.download_url}', '${item.name}', '${item.type}')"` : '';

                return `
                <div class="glass bg-white/50 dark:bg-slate-800/50 p-4 rounded-xl shadow-sm flex items-center gap-3 hover:bg-white dark:hover:bg-slate-800 transition-colors group border border-transparent hover:border-indigo-200 dark:hover:border-slate-600">
                    <div ${mainAction} class="flex items-center gap-3 flex-1 min-w-0 cursor-pointer">
                        <div class="w-10 h-10 rounded-full bg-slate-100 dark:bg-slate-700 flex items-center justify-center flex-shrink-0">
                            <i data-lucide="${icon}" class="${iconClass} w-5 h-5"></i>
                        </div>
                        <div class="min-w-0 flex-1">
                            <p class="text-sm font-semibold text-slate-700 dark:text-slate-200 truncate group-hover:text-indigo-600 dark:group-hover:text-indigo-400">${item.name}</p>
                            <p class="text-xs text-slate-400">${isDir ? 'Folder' : (item.size / 1024).toFixed(1) + ' KB'}</p>
                        </div>
                    </div>
                    
                    <div class="flex items-center gap-1">
                        ${!isDir ? `
                        <button ${previewAction} class="p-2 text-slate-400 hover:text-indigo-500 hover:bg-indigo-50 dark:hover:bg-indigo-900/30 rounded-lg transition-colors" title="Preview File">
                            <i data-lucide="eye" class="w-4 h-4"></i>
                        </button>
                        ` : ''}
                        ${isDir ? `<button onclick="openFolder('${item.path}')" class="p-2 text-slate-400 hover:text-indigo-500"><i data-lucide="chevron-right" class="w-4 h-4"></i></button>` : ''}
                    </div>
                </div>
                `;
            }).join('');
            lucide.createIcons();
        }

        // --- PREVIEW LOGIC ---
        async function openPreview(url, name, type) {
            const modal = document.getElementById('previewModal');
            const title = document.getElementById('previewTitle');
            const content = document.getElementById('previewContent');
            const imgContainer = document.getElementById('previewImageContainer');
            const img = document.getElementById('previewImage');
            const loader = document.getElementById('previewLoader');
            const dlBtn = document.getElementById('previewDownloadBtn');
            const copyBtn = document.getElementById('previewCopyBtn');

            // Setup Modal
            modal.classList.remove('hidden');
            title.textContent = name;
            loader.classList.remove('hidden');
            content.classList.add('hidden');
            imgContainer.classList.add('hidden');

            // Setup Download Button
            dlBtn.onclick = () => {
                showToast("Downloading file...", "info");
                saveAs(url, name);
            };

            const isImage = name.match(/\.(jpg|jpeg|png|gif|svg|webp)$/i);

            try {
                if (isImage) {
                    img.src = url;
                    // Hide Copy button for images
                    copyBtn.classList.add('hidden');
                    img.onload = () => {
                        loader.classList.add('hidden');
                        imgContainer.classList.remove('hidden');
                    };
                } else {
                    const res = await fetch(url);
                    const text = await res.text();
                    content.textContent = text;

                    // Show Copy button for text
                    copyBtn.classList.remove('hidden');

                    // Setup Copy Action
                    copyBtn.onclick = () => {
                        navigator.clipboard.writeText(text).then(() => {
                            showToast("Copied to clipboard!", "success");
                        }).catch(err => {
                            showToast("Failed to copy", "error");
                        });
                    };

                    loader.classList.add('hidden');
                    content.classList.remove('hidden');
                }
            } catch (e) {
                showToast("Could not preview file", "error");
                closePreview();
            }
        }

        function closePreview() {
            document.getElementById('previewModal').classList.add('hidden');
        }

        // --- DOWNLOAD FOLDER ---
        async function downloadCurrentView() {
            const btn = ui.dlBtn;
            const originalHTML = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = `<i class="animate-spin w-4 h-4 mr-2 border-2 border-white border-t-transparent rounded-full"></i> Zipping...`;

            try {
                showToast("Starting download...", "info");
                const zip = new JSZip();
                const folderName = state.currentPath ? state.currentPath.split('/').pop() : state.currentRepo;

                await recursiveFetch(state.currentPath, zip);

                const content = await zip.generateAsync({ type: "blob" });
                saveAs(content, `${folderName}.zip`);
                showToast("Download Complete!", "success");
            } catch (err) {
                showToast("Download failed.", "error");
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalHTML;
            }
        }

        async function recursiveFetch(path, zipFolder) {
            let url = `https://api.github.com/repos/${state.username}/${state.currentRepo}/contents/${path}`;
            if (state.branch) url += `?ref=${state.branch}`;

            const res = await githubFetch(url);
            if (!res.ok) throw new Error(`Error accessing ${path}`);
            const data = await res.json();
            const items = Array.isArray(data) ? data : [data];

            for (const item of items) {
                if (item.type === 'file') {
                    const fileData = await fetch(item.download_url).then(r => r.blob());
                    zipFolder.file(item.name, fileData);
                } else if (item.type === 'dir') {
                    const newFolder = zipFolder.folder(item.name);
                    await recursiveFetch(item.path, newFolder);
                }
            }
        }

        // --- UTILS ---
        function updateBreadcrumbs() {
            let html = `<span class="hover:text-indigo-600 dark:hover:text-indigo-400 cursor-pointer transition-colors" onclick="location.reload()">
                            <i data-lucide="home" class="w-4 h-4 inline mb-1"></i>
                        </span>`;

            if (state.currentRepo) {
                html += ` <span class="text-slate-300">/</span> <span class="hover:text-indigo-600 dark:hover:text-indigo-400 cursor-pointer font-semibold" onclick="openRepo('${state.currentRepo}')">${state.currentRepo}</span>`;
            }

            if (state.currentPath) {
                html += ` <span class="text-slate-300">/</span> <span class="text-indigo-600 dark:text-indigo-400 font-semibold">${state.currentPath.split('/').pop()}</span>`;
            }
            ui.breadcrumbs.innerHTML = html;
            lucide.createIcons();
        }

        function showLoader(show) {
            ui.loader.classList.toggle('hidden', !show);
            if (show) ui.grid.innerHTML = '';
        }

        function showToast(msg, type = "info") {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');

            const colors = {
                error: 'bg-red-500',
                success: 'bg-emerald-500',
                info: 'bg-slate-800 dark:bg-slate-700'
            };

            toast.className = `${colors[type]} text-white px-4 py-3 rounded-lg shadow-xl text-sm font-medium flex items-center gap-2 transform transition-all duration-300 translate-y-10 opacity-0`;
            toast.innerHTML = type === 'success' ? `<i data-lucide="check-circle" class="w-4 h-4"></i> ${msg}` : msg;

            container.appendChild(toast);
            lucide.createIcons();

            requestAnimationFrame(() => {
                toast.classList.remove('translate-y-10', 'opacity-0');
            });

            setTimeout(() => {
                toast.classList.add('translate-y-10', 'opacity-0');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        async function githubFetch(url) {
            const headers = state.token ? { 'Authorization': `token ${state.token}` } : {};
            return fetch(url, { headers });
        }
        // === DISABLE RIGHT CLICK ===
        document.addEventListener('contextmenu', function (e) {
            e.preventDefault();
        });

        // === DISABLE INSPECT SHORTCUTS ===
        document.onkeydown = function (e) {
            // F12
            if (e.keyCode == 123) {
                return false;
            }

            // Ctrl+Shift+I (Inspect)
            if (e.ctrlKey && e.shiftKey && e.keyCode == 73) {
                return false;
            }

            // Ctrl+Shift+J (Console)
            if (e.ctrlKey && e.shiftKey && e.keyCode == 74) {
                return false;
            }

            // Ctrl+U (View Source)
            if (e.ctrlKey && e.keyCode == 85) {
                return false;
            }
        };
    </script>
</body>

</html>